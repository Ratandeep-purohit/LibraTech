{% extends "layout.html" %}

{% block page_title %}Admin Overview{% endblock %}

{% block dashboard_content %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Stat Cards -->
    <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
        <div
            class="absolute top-0 right-0 w-24 h-24 bg-purple-500/10 rounded-full blur-xl -mr-10 -mt-10 transition group-hover:bg-purple-500/20">
        </div>
        <div class="flex items-start justify-between">
            <div>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Total Books</p>
                <h3 class="text-3xl font-bold text-white">{{ total_books }}</h3>
            </div>
            <div class="w-12 h-12 rounded-xl bg-purple-500/20 text-purple-400 flex items-center justify-center text-xl">
                <i class="fas fa-book"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-xs text-green-400">
            <i class="fas fa-arrow-up mr-1"></i> <span class="font-bold">New</span> <span
                class="text-slate-500 ml-1">Latest Additions</span>
        </div>
    </div>

    <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
        <div
            class="absolute top-0 right-0 w-24 h-24 bg-blue-500/10 rounded-full blur-xl -mr-10 -mt-10 transition group-hover:bg-blue-500/20">
        </div>
        <div class="flex items-start justify-between">
            <div>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Active Students</p>
                <h3 class="text-3xl font-bold text-white">{{ total_students }}</h3>
            </div>
            <div class="w-12 h-12 rounded-xl bg-blue-500/20 text-blue-400 flex items-center justify-center text-xl">
                <i class="fas fa-user-graduate"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-xs text-blue-400">
            <i class="fas fa-check-circle mr-1"></i> <span class="font-bold">Verified</span> <span
                class="text-slate-500 ml-1">Accounts</span>
        </div>
    </div>

    <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
        <div
            class="absolute top-0 right-0 w-24 h-24 bg-green-500/10 rounded-full blur-xl -mr-10 -mt-10 transition group-hover:bg-green-500/20">
        </div>
        <div class="flex items-start justify-between">
            <div>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Issued Books</p>
                <h3 class="text-3xl font-bold text-white">{{ issued_books }}</h3>
            </div>
            <div class="w-12 h-12 rounded-xl bg-green-500/20 text-green-400 flex items-center justify-center text-xl">
                <i class="fas fa-book-reader"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-xs text-slate-400">
            <span class="text-slate-500">Currently borrowed</span>
        </div>
    </div>

    <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
        <div
            class="absolute top-0 right-0 w-24 h-24 bg-red-500/10 rounded-full blur-xl -mr-10 -mt-10 transition group-hover:bg-red-500/20">
        </div>
        <div class="flex items-start justify-between">
            <div>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Total Fines</p>
                <h3 class="text-3xl font-bold text-white">&#8377;{{ "%.2f"|format(total_fines) }}</h3>
            </div>
            <div class="w-12 h-12 rounded-xl bg-red-500/20 text-red-400 flex items-center justify-center text-xl">
                <i class="fas fa-coins"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-xs text-red-400">
            <i class="fas fa-exclamation-circle mr-1"></i> <span class="font-bold">Library</span> <span
                class="text-slate-500 ml-1">Penalties</span>
        </div>
    </div>
</div>

<!-- Fee Stats Row -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="glass-card p-6 rounded-2xl relative overflow-hidden group border-l-4 border-green-500">
        <div class="flex items-start justify-between">
            <div>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Overall Fees Collected</p>
                <h3 class="text-4xl font-extrabold text-white">&#8377;{{ "%.2f"|format(total_fees_collected) }}</h3>
            </div>
            <div
                class="w-14 h-14 rounded-2xl bg-green-500/20 text-green-400 flex items-center justify-center text-2xl shadow-lg shadow-green-500/10">
                <i class="fas fa-cash-register"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-xs text-green-400 bg-green-500/10 w-fit px-2 py-1 rounded-lg">
            <i class="fas fa-chart-line mr-1"></i> <span class="font-bold">Revenue</span> <span
                class="text-slate-500 ml-1">Total Income</span>
        </div>
    </div>

    <div class="glass-card p-6 rounded-2xl relative overflow-hidden group border-l-4 border-orange-500">
        <div class="flex items-start justify-between">
            <div>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Overall Fees Due</p>
                <h3 class="text-4xl font-extrabold text-white">&#8377;{{ "%.2f"|format(total_fees_due) }}</h3>
            </div>
            <div
                class="w-14 h-14 rounded-2xl bg-orange-500/20 text-orange-400 flex items-center justify-center text-2xl shadow-lg shadow-orange-500/10">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-xs text-orange-400 bg-orange-500/10 w-fit px-2 py-1 rounded-lg">
            <i class="fas fa-clock mr-1"></i> <span class="font-bold">Pending</span> <span
                class="text-slate-500 ml-1">To be collected</span>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Chart Section -->
    <div class="glass-card p-6 rounded-2xl border border-white/5">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-indigo-500/20 text-indigo-400 flex items-center justify-center">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-white">Monthly Activity</h4>
                    <p class="text-xs text-slate-500" id="mainChartTitle">Books Issued</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-2">
                <select id="chartTimeSelector"
                    class="bg-white/5 border border-white/10 rounded-xl px-3 py-1.5 text-xs text-slate-300 focus:outline-none focus:border-indigo-500 transition">
                    <option value="7d" class="bg-slate-800">Last 7 Days</option>
                    <option value="15d" class="bg-slate-800">Last 15 Days</option>
                    <option value="30d" class="bg-slate-800" selected>Last 30 Days</option>
                    <option value="6m" class="bg-slate-800">Last 6 Months</option>
                    <option value="1y" class="bg-slate-800">Last 1 Year</option>
                </select>
                <select id="chartMetricSelector"
                    class="bg-white/5 border border-white/10 rounded-xl px-3 py-1.5 text-xs text-slate-300 focus:outline-none focus:border-indigo-500 transition">
                    <option value="monthly_issues" class="bg-slate-800">Monthly Issues</option>
                    <option value="monthly_fees" class="bg-slate-800">Fee Collections (₹)</option>
                    <option value="monthly_regs" class="bg-slate-800">Student Registrations</option>
                    <option value="monthly_fines" class="bg-slate-800">Fine Collections (₹)</option>
                    <option value="categories" class="bg-slate-800">Category Mix</option>
                    <option value="book_status" class="bg-slate-800">Stock Availability</option>
                </select>
                <select id="chartTypeSelector"
                    class="bg-white/5 border border-white/10 rounded-xl px-3 py-1.5 text-xs text-slate-300 focus:outline-none focus:border-indigo-500 transition">
                    <option value="line" class="bg-slate-800">Line Graph</option>
                    <option value="bar" class="bg-slate-800">Bar Chart</option>
                    <option value="pie" class="bg-slate-800">Pie Chart</option>
                    <option value="doughnut" class="bg-slate-800">Doughnut</option>
                    <option value="polarArea" class="bg-slate-800">Polar Area</option>
                </select>
            </div>
        </div>
        <div class="relative h-80 w-full">
            <canvas id="issueChart"></canvas>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="glass-card p-6 rounded-2xl border border-white/5">
        <h4 class="text-lg font-bold text-white mb-6">Quick Actions</h4>
        <div class="grid grid-cols-2 gap-4">
            <a href="{{ url_for('add_book') }}"
                class="p-4 rounded-xl border border-white/10 bg-white/5 hover:bg-indigo-500/20 hover:border-indigo-500/30 transition-all text-center group">
                <div
                    class="w-10 h-10 mx-auto bg-indigo-500/20 rounded-lg flex items-center justify-center text-indigo-400 mb-3 group-hover:scale-110 transition-transform">
                    <i class="fas fa-plus"></i>
                </div>
                <span class="font-medium text-slate-300 text-sm group-hover:text-white">Add Book</span>
            </a>
            <a href="{{ url_for('issue_book') }}"
                class="p-4 rounded-xl border border-white/10 bg-white/5 hover:bg-green-500/20 hover:border-green-500/30 transition-all text-center group">
                <div
                    class="w-10 h-10 mx-auto bg-green-500/20 rounded-lg flex items-center justify-center text-green-400 mb-3 group-hover:scale-110 transition-transform">
                    <i class="fas fa-hand-holding"></i>
                </div>
                <span class="font-medium text-slate-300 text-sm group-hover:text-white">Issue Book</span>
            </a>
            <a href="{{ url_for('add_student') }}"
                class="p-4 rounded-xl border border-white/10 bg-white/5 hover:bg-purple-500/20 hover:border-purple-500/30 transition-all text-center group">
                <div
                    class="w-10 h-10 mx-auto bg-purple-500/20 rounded-lg flex items-center justify-center text-purple-400 mb-3 group-hover:scale-110 transition-transform">
                    <i class="fas fa-user-plus"></i>
                </div>
                <span class="font-medium text-slate-300 text-sm group-hover:text-white">Add Student</span>
            </a>
            <a href="{{ url_for('fine_list') }}"
                class="p-4 rounded-xl border border-white/10 bg-white/5 hover:bg-red-500/20 hover:border-red-500/30 transition-all text-center group">
                <div
                    class="w-10 h-10 mx-auto bg-red-500/20 rounded-lg flex items-center justify-center text-red-400 mb-3 group-hover:scale-110 transition-transform">
                    <i class="fas fa-coins"></i>
                </div>
                <span class="font-medium text-slate-300 text-sm group-hover:text-white">Collect Fines</span>
            </a>
            <a href="{{ url_for('analytics_dashboard') }}"
                class="p-4 rounded-xl border border-white/10 bg-white/5 hover:bg-amber-500/20 hover:border-amber-500/30 transition-all text-center group">
                <div
                    class="w-10 h-10 mx-auto bg-amber-500/20 rounded-lg flex items-center justify-center text-amber-400 mb-3 group-hover:scale-110 transition-transform">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span class="font-medium text-slate-300 text-sm group-hover:text-white">Intelligence</span>
            </a>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let myChart = null;
    let chartData = null;

    function getChartGradient(ctx, isLight) {
        const chartArea = ctx.chartArea;
        if (!chartArea) return 'rgba(99, 102, 241, 0.4)';
        const gradient = ctx.ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
        if (isLight) {
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0)');
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0.4)');
        } else {
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0)');
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0.2)');
        }
        return gradient;
    }

    function renderMasterChart() {
        if (!chartData) return;
        const metricKey = document.getElementById('chartMetricSelector').value;
        const chartType = document.getElementById('chartTypeSelector').value;
        const timeRange = document.getElementById('chartTimeSelector').value;
        const chartCanvas = document.getElementById('issueChart');
        if (!chartCanvas) return;

        const isLight = document.documentElement.classList.contains('light-mode');
        const dataSet = chartData[metricKey];
        if (!dataSet) return;

        const rangeNames = {
            '7d': 'Weekly',
            '15d': 'Fortnightly',
            '30d': 'Monthly',
            '6m': 'Half-Yearly',
            '1y': 'Yearly'
        };

        const metricConfigs = {
            'monthly_issues': { label: 'Issues', unit: '', prefix: '' },
            'monthly_fees': { label: 'Revenue', unit: '', prefix: '₹' },
            'monthly_regs': { label: 'Registrations', unit: '', prefix: '' },
            'monthly_fines': { label: 'Fines', unit: '', prefix: '₹' },
            'categories': { label: 'Books', unit: '', prefix: '' },
            'book_status': { label: 'Copies', unit: '', prefix: '' }
        };

        const config = metricConfigs[metricKey];
        const labelsMap = {
            'monthly_issues': 'Issues',
            'monthly_fees': 'Fee Collections (₹)',
            'monthly_regs': 'Student Registrations',
            'monthly_fines': 'Fine Collections (₹)',
            'categories': 'Category Mix',
            'book_status': 'Stock Availability'
        };

        // Static names for categories and book status
        const isStatic = ['categories', 'book_status'].includes(metricKey);
        const activityTitle = isStatic ? labelsMap[metricKey] : `${rangeNames[timeRange]} ${labelsMap[metricKey]}`;
        const mainHeader = isStatic ? 'Visual Mix' : `${rangeNames[timeRange]} Activity`;

        document.getElementById('mainChartTitle').innerText = activityTitle;
        chartCanvas.closest('.glass-card').querySelector('h4').innerText = mainHeader;

        if (myChart) myChart.destroy();

        const isLinear = ['line', 'bar'].includes(chartType);
        const isPolar = chartType === 'polarArea';
        const palette = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#f43f5e', '#84cc16'];

        const ctx = chartCanvas.getContext('2d');

        myChart = new Chart(ctx, {
            type: chartType,
            data: {
                labels: dataSet.labels,
                datasets: [{
                    label: config.label,
                    data: dataSet.values,
                    borderColor: !isLinear ? (isLight ? '#fff' : 'rgba(255,255,255,0.1)') : '#6366f1',
                    backgroundColor: function (context) {
                        if (!isLinear) return palette;
                        if (chartType === 'line') return getChartGradient(context.chart, isLight);
                        return 'rgba(99, 102, 241, 0.7)';
                    },
                    borderWidth: !isLinear ? (isLight ? 2 : 1) : 3,
                    tension: 0.4,
                    fill: chartType === 'line',
                    pointBackgroundColor: '#6366f1',
                    pointRadius: !isLinear ? 0 : 4,
                    borderRadius: chartType === 'bar' ? 6 : 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: !isLinear,
                        position: 'right',
                        labels: {
                            color: isLight ? '#475569' : '#94a3b8',
                            font: { size: 10, family: 'Outfit' },
                            boxWidth: 12
                        }
                    },
                    tooltip: {
                        backgroundColor: isLight ? '#fff' : '#1e293b',
                        titleColor: isLight ? '#1e293b' : '#fff',
                        bodyColor: isLight ? '#475569' : '#94a3b8',
                        borderColor: isLight ? '#e2e8f0' : 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function (context) {
                                let val = context.parsed.y !== undefined ? context.parsed.y : context.parsed;
                                return `${context.label}: ${config.prefix}${val.toLocaleString()}${config.unit}`;
                            }
                        }
                    }
                },
                scales: isLinear ? {
                    y: {
                        beginAtZero: true,
                        grid: { color: isLight ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.05)' },
                        ticks: {
                            color: isLight ? '#475569' : '#94a3b8',
                            callback: value => config.prefix + value.toLocaleString()
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: isLight ? '#475569' : '#94a3b8' }
                    }
                } : (isPolar ? {
                    r: {
                        ticks: { display: false },
                        grid: { color: isLight ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.05)' }
                    }
                } : {})
            }
        });
    }

    function initAnalytics() {
        const timeRange = document.getElementById('chartTimeSelector').value;
        fetch(`/analytics/data?range=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                chartData = data;
                renderMasterChart();
            });
    }

    // Initialize
    initAnalytics();

    document.getElementById('chartMetricSelector').addEventListener('change', renderMasterChart);
    document.getElementById('chartTypeSelector').addEventListener('change', renderMasterChart);
    document.getElementById('chartTimeSelector').addEventListener('change', initAnalytics);
</script>
{% endblock %}